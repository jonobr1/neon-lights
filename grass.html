<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Grass</title>
  </head>
  <body>
    <div class="scripts">

      <script src="./third-party/three.js"></script>
      <script src="./third-party/two.js"></script>
      <script src="./third-party/trail.js"></script>

      <script>

        var two = new Two({
          type: Two.Types.canvas,
          width: 512,
          height: 512,
          overdraw: true,
          ratio: 1
        });

        var renderer = new THREE.WebGLRenderer({ antialias: true });
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera();

        var plane = new THREE.Mesh(
          new THREE.PlaneBufferGeometry(5, 1, 30, 3),
          new THREE.ShaderMaterial({

            transparent: true,
            // wireframe: true,

            uniforms: {

              time: { type: 'f', value: 0 },
              variance: { type: 'f', value: 3 },
              amplitude: { type: 'f', value: 16 },
              billboard: { type: 'v2', value: new THREE.Vector2(5, 1) },
              resolution: { type: 'v2', value: new THREE.Vector2(30, 2) },
              map: { type: 't', value: null },
              color: { type: 'c', value: new THREE.Color(0x8cc63f) }

            },

            vertexShader: [

              ['const float PI = ', Math.PI, ';'].join(''),

              'uniform float time;',
              'uniform float variance;',
              'uniform float amplitude;',
              'uniform vec2 billboard;',

              'varying vec2 vUv;',

              'void main() {',

                'vUv = uv;',

                'vec3 pos = vec3( position );',

                'float index = floor( pos.x + billboard.x / 2.0 );',
                'float sway = ( pos.y + billboard.y / 2.0 );',
                'float t = time + index * variance;',

                'pos.x += pow( sway, 2.0 ) * sin( t ) / amplitude;',
                'pos.z += pow( sway, 2.0 ) * cos( t ) / amplitude;',

                'gl_Position = projectionMatrix * modelViewMatrix * vec4( pos, 1.0 );',

              '}'

            ].join('\n'),

            fragmentShader: [

              'uniform vec2 billboard;',
              'uniform vec2 resolution;',
              'uniform sampler2D map;',
              'uniform vec3 color;',

              'varying vec2 vUv;',

              'void main() {',

                'float index = floor( vUv.x * billboard.x );',
                'vec2 uv = vec2( mod( vUv.x * billboard.x, 1.0 ), vUv.y );',

                'float limit = 1.0 / ( resolution.x / billboard.x );',
                'if ( uv.x >= 1.0 - limit || uv.x <= 0.01 ) {',
                  'discard;',
                '}',

                'vec4 texel = texture2D( map, uv );',
                'float t = ( texel.r + texel.g + texel.b ) / 3.0;',
                'vec3 c = mix( color, pow( color, vec3( 4.0 ) ), vUv.y );',

                'gl_FragColor = vec4( mix( texel, vec4( c, 1.0 ), t ) );',

              '}'

            ].join('\n')
          })
        );

        plane.material.uniforms.map.value = new THREE.Texture(two.renderer.domElement);

        scene.add(plane);

        setup();

        function setup() {

          camera.position.z = 4;

          Two.Utils.extend(two.renderer.domElement.style, {
            display: 'block',
            position: 'absolute',
            top: 25 + 'px',
            left: 25 + 'px',
            border: '1px solid #ccc',
            width: 50 + 'px',
            height: 50 + 'px'
          });

          Two.Utils.extend(renderer.domElement.style, {
            display: 'block',
            position: 'absolute',
            top: 0,
            left: 0
          });

          document.body.appendChild(renderer.domElement);
          two.appendTo(document.body);

          window.addEventListener('resize', resize, false);
          window.addEventListener('click', drawGrass, false);

          resize();
          loop();

          drawGrass();

        }

        function resize() {

          var width = window.innerWidth;
          var height = window.innerHeight;

          renderer.setSize(width, height);
          camera.aspect = width / height;
          camera.updateProjectionMatrix();

        }

        function drawGrass() {

          two.renderer.ctx.clearRect(
            0, 0, two.renderer.domElement.width, two.renderer.domElement.height);

          var amount = Math.floor(Math.random() * 8) + 8;
          var range = Two.Utils.range(16);
          var trail = new Two.Trail(Two.Utils.map(range, function(i) {
            return new Two.Vector();
          }));

          trail.curved = true;
          trail.closed = true;
          trail.noStroke();

          two.add(trail);

          for (var i = 0; i < amount; i++) {

            var points = trail.destinations;
            var step = Math.floor(
              Math.sqrt(Math.random()) * two.height / points.length// (points.length - 3)
            );
            var phi = Math.random() * Math.PI / 4;

            for (var j = 0; j < points.length; j++) {

              var pct = j / (points.length - 1);
              var p = points[j - 1];
              var theta = pct * phi - Math.PI / 2;

              var x = 0;
              var y = 0;

              if (p) {
                x = step * Math.cos(theta) + p.x;
                y = step * Math.sin(theta) + p.y;
              }

              points[j].set(x, y);

            }

            trail.distance = (0.5 * Math.random() + 0.2) * step * 2;

            var seed = Math.floor(200 * Math.random() + 55);
            trail.fill = 'rgb('
              + seed + ','
              + seed + ','
              + seed + ')';

            trail.update();

            var rect = trail.getBoundingClientRect(true);
            var limit = plane.material.uniforms.resolution.value.x / plane.material.uniforms.billboard.value.x;

            var ox = Math.random() * (two.width * ((limit - 1) / limit) - rect.width);
            var oy = two.height + step;

            ox += trail.distance;
            trail.translation.set(ox, oy);


            two.update();

          }

          plane.material.uniforms.map.value.needsUpdate = true;

          trail.remove();
          Two.Utils.release(trail);

        }

        function loop() {

          requestAnimationFrame(loop);
          plane.material.uniforms.time.value += 0.07;
          renderer.render(scene, camera);

        }

      </script>
    </div>
  </body>
</html>
